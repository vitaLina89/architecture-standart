### **Название задачи:** Передача ставок в кол-цент
### **Автор:** Вита
### **Дата:** 12.11.2025

### **Функциональные требования**

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :-: | :- | :- | :- |
| 1 | Сотрудник внутреннего кол-центра, Система кол-центра | Просмотр актуальных ставок | 1. Оператор открывает карточку клиента или общую справку по депозитам.<br>2. Система кол-центра запрашивает текущие ставки через внутренний API оркестрации депозитов.<br>3. Оператор видит список депозитов и ставки, подтвержденные АБС. |
| 2 | Система оркестрации депозитов, Сервис ставок | Публикация обновлённых ставок | 1. АБС обновляет ставки и публикует событие или обновление в таблицах Oracle.<br>2. Оркестрация синхронизирует данные, актуализирует кэш и журнал изменений.<br>3. Сервис ставок фиксирует версию и обеспечивает доступ каналам и кол-центру. |
| 3 | Система оркестрации депозитов, Партнёрский кол-центр | Формирование файла ставок для партнёра | 1. Scheduler в оркестрации инициирует формирование файла (CSV/Excel) со ставками.<br>2. Файл шифруется/подписывается и выгружается на защищённый SFTP сервера партнёра.<br>3. Статус выгрузки фиксируется в журнале, уведомление отправляется ответственным. |
| 4 | Партнёрский кол-центр | Получение файла ставок | 1. Партнёрская система подключается к SFTP и загружает актуальный файл.<br>2. Сотрудники партнёра используют данные для консультаций клиентов.<br>3. В случае ошибки партнёр получает уведомление и запрашивает повторную выгрузку. |
| 5 | Оператор кол-центра, Оркестрация, Система мониторинга | Контроль актуальности ставок | 1. Оператор или аналитик запускает отчёт/дашборд о времени последнего обновления.<br>2. Система мониторинга отображает задержки в выгрузке или синхронизации.<br>3. При превышении порогов срабатывает оповещение ответственным. |

### **Нефункциональные требования**

| **№** | **Требование** |
| :-: | :- |
| N1 | Актуальность ставок для внутренних операторов не хуже 5 минут от времени публикации в АБС. |
| N2 | Файл для партнёрского кол-центра обновляется минимум 1 раз в час и по событию изменения ставок. |
| N3 | Время формирования и выгрузки файла ≤ 2 минут, успешность не ниже 99%. |
| N4 | Передача ставок должна быть защищена (SFTP, шифрование/подпись файлов, контроль доступа). |
| N5 | Решение должно использовать существующую инфраструктуру (Kafka, .NET, Oracle, SFTP), без доработки сторонних систем подрядчика. |
| N6 | Процесс должен масштабироваться при росте количества депозитов и частоты обновлений (горизонтальное масштабирование сервисов, батч-формирование файлов). |
| N7 | Логи и метрики по синхронизации ставок собираются централизованно для оперативной поддержки (ELK, Prometheus). |

### **Решение**

**Диаграммы**

- C4 Context: `Task4/context-callcenter-rates.md`
- C4 Component: `Task4/component-callcenter-rates.md`
- RoadMap (draw.io): `Task4/RoadMap_bank_Standart.drawio`

**Концепция**

- **Единый источник ставок.** АБС остаётся системой-источником, хранит таблицы ставок и публикует события обновления (через существующий интеграционный слой). Оркестрация депозитов получает изменения, обновляет кэш Redis и сохраняет версии ставок в MS SQL.
- **Доступ внутреннего кол-центра.** Система кол-центра (Spring Boot) реализует REST-клиент к API оркестрации `/support/rates`. Ответ содержит список депозитов с метаданными и timestamp. Доступ защищается через корпоративный API Gateway и OAuth2 service-to-service.
- **Доступ партнёрского кол-центра.** В оркестрации добавляется модуль экспортов: по расписанию и на событие изменения ставок формируется CSV/Excel (UTF-8, RU), файл шифруется PGP и выкладывается на SFTP (зона DMZ). Партнёр забирает файл по заранее согласованным credentials. Метаданные экспорта сохраняются и визуализируются.
- **Надёжность и мониторинг.** Kafka обеспечивает повторяемость событий; в случае недоступности SFTP файл ставится в очередь повторной отправки. Health-checks, алерты в Grafana/Prometheus, логи в ELK с correlation ID.
- **Команды и ответственность.**
  - Команда интеграции депозитов: логика синхронизации ставок, API, генерация файлов, очереди.
  - Команда АБС: публикация ставок, обеспечение корректности данных, расписания обновления.
  - Команда кол-центра: доработка UI и REST-клиента, отображение ставок.
  - Команда партнёрского кол-центра: настройка приёма файлов, процедуры загрузки.
  - Команда безопасности/инфраструктуры: SFTP, ключи шифрования, мониторинг.

**Соответствие требованиям**

- N1–N3: событийный обмен + расписание экспорта, буферизация и повторные попытки.
- N4: SFTP с PGP, ограниченный доступ, учётные записи и аудит.
- N5–N6: переиспользование существующих технологий банка, масштабируемые воркеры.
- N7: централизованное логирование и метрики экспорта, SLA на обновления.

### **Альтернативы**

1. **Прямой доступ кол-центров в АБС.** Отклонён из-за отсутствия веб-API и риска перегрузки АБС; нарушает ограничение +R3.
2. **Отправка ставок по электронной почте.** Несоответствие требованиям безопасности и контроля версий; трудно автоматизировать.
3. **Создание отдельного микросервиса у партнёра.** Повышает стоимость и время; отсутствие интеграционных возможностей у партнёра (нет API).

### **Недостатки, ограничения, риски**

1. **Задержки актуализации.** При сбоях в событии обновления возможна задержка до следующего расписания; требуется мониторинг и ручной перезапуск.
2. **Зависимость от SFTP.** Канал передачи — узкое место: необходим контроль доступности, регламенты ротации ключей.
3. **Усложнение оркестрации.** Дополнительные модули (экспорт, шифрование, аудит) увеличивают нагрузку на команду интеграции.
4. **Человеческий фактор партнёра.** Возможны ошибки при ручной загрузке файлов; требуется обучение и регламент обратной связи.
5. **Безопасность данных.** Потребуется регулярный аудит ключей и настроек, чтобы исключить утечку чувствительной информации.

### **Список крупных задач по системам**

| **Система / Команда** | **Крупные задачи** |
| :- | :- |
| Оркестрация депозитов (.NET) | 1. Реализовать сервис синхронизации ставок из АБС и хранение версий.<br>2. Добавить REST API `/support/rates` с авторизацией.<br>3. Реализовать экспорт ставок в CSV/Excel, шифрование и доставку на SFTP.<br>4. Настроить ретраи и мониторинг выгрузок. |
| Система кол-центра (внутренняя) | 1. Добавить интеграционный модуль к API оркестрации (OAuth2, кеширование).<br>2. Обновить UI для отображения ставок и времени актуализации.<br>3. Настроить алерты по устаревшим данным. |
| Партнёрский кол-центр | 1. Настроить приём файлов через SFTP, регламентировать расписание загрузок.<br>2. Импортировать данные в локальную систему/Excel, обучить операторов.<br>3. Организовать обратную связь по инцидентам. |
| АБС | 1. Обеспечить публикацию ставок (таблицы, события).<br>2. Согласовать SLA обновлений и контроль целостности данных.<br>3. Настроить аудит изменений ставок. |
| Инфраструктура и безопасность | 1. Развернуть и настроить SFTP (DMZ, доступы, журналирование).<br>2. Настроить PGP-ключи, хранение секретов (Vault).<br>3. Подключить метрики и алерты (ELK, Prometheus, Grafana). |


